@startuml
title SOVD Gateway Architecture (Axum Reverse Proxy + mDNS Discovery)

skinparam componentStyle rectangle
skinparam rectangle {
  BackgroundColor<<gateway>> #E3F2FD
  BackgroundColor<<server>> #E8F5E9
  BackgroundColor<<mdns>> #FFF3E0
}

actor "Offboard Client" as Client

rectangle "SOVD Gateway" <<gateway>> {
  component "Axum Web Server\n(HTTP entrypoint)" as Axum
  component "reverse-proxy\n(Request forwarding)" as Proxy
  component "Routing Table\n(base_uri suffix â†’ UpstreamInfo)" as Routing
  component "mDNS Listener\n(Service discovery task)" as MDNSListener
  component "Upstream Registry\n(<HashMap>)" as Registry

  Axum --> Proxy : HTTP Requests
  Proxy --> Routing : Lookup base_uri suffix
  Routing --> Registry : Resolve UpstreamInfo
  MDNSListener --> Registry : Add/Remove UpstreamInfo
}

rectangle "Vehicle Network / Upstream Servers" {
  component "Chassis SOVD Server" <<server>> as Area1
  component "Classic Diagnostics Adapter" <<server>> as CDA
  component "Powertrain SOVD Server (optional)" <<server>> as Area2
  component "mDNS Responder" <<mdns>> as MDNSResponder

  MDNSResponder -[hidden]-> Area1
  MDNSResponder -[hidden]-> CDA
  MDNSResponder -[hidden]-> Area2
}

Client --> Axum : HTTP API calls\n(GET {gateway_uri}/chassis/api/data)
MDNSResponder --> MDNSListener : mDNS Advertise/Goodbye\n(chassis._sovd._tcp.local)
Proxy --> Area1 : Forwarded HTTP Requests\n(X-Forwarded-*)
Proxy --> CDA : Forwarded HTTP Requests
Proxy --> Area2 : (if reachable through Area1)

note right of Routing
Routing Table Example:
| Instance                     | Hostname    | IP Address   | Port | Vendor URI Suffix | Base URI                     | Entity List |
| chassis._sovd._tcp.local  | chassis    | 192.168.1.10 | 7690 | Mercedes        | http://chassis:7690/<oem-specific>/v1     | `{base_uri}/components/Steering`, `http://chassis/v1/components/Braking` |
| powertrain._sovd._tcp.local   | powertrain | 10.0.1.10    | 7690 | BMW             | http://powertrain:7690/<oem-specific>/v1  | `{base_uri}/components/Inverter`, `{base_uri}/area/Transmission` |
end note

note right of Registry
pub struct UpstreamInfo {
    pub instance_name: String,               // e.g. "{entity}._sovd._tcp.local"
    pub hostname: String,                    // e.g. "<SOVD-Server-Host>"
    pub address: Option<IpAddr>,             // resolved IP
    pub port: u16,                           // e.g. 7690
    pub vendor_uri_suffix: String,           // e.g. "http://chassis.hpc:7690/<vendor_uri_suffix>"
    pub version: String,                     // e.g. "v1"
    pub base_uri: String,                    // e.g. "http://chassis.hpc:7690/<vendor_uri_suffix>/v1"
    pub entities: Vec<String>,               // entity-collections url list
}
end note

@enduml